# Status - 系统监控功能

## 功能概述

实时监控系统性能指标，包括CPU、GPU、内存、磁盘、网络、电池等，提供系统健康评分和性能诊断。

## 核心价值

- **实时监控**：1秒刷新间隔
- **全面指标**：覆盖所有关键系统资源
- **健康评分**：0-100分系统健康评估
- **性能诊断**：快速定位性能瓶颈

## 技术实现

### 编程语言
Go语言 + Bubble Tea TUI框架 + gopsutil库

### 核心数据结构
```go
type MetricsSnapshot struct {
    CollectedAt    time.Time        // 采集时间
    Host           string            // 主机名
    Platform       string            // 平台信息
    Uptime         string            // 运行时间
    Procs          uint64            // 进程数
    Hardware       HardwareInfo      // 硬件信息
    HealthScore    int               // 健康分数 (0-100)

    CPU            CPUStatus         // CPU状态
    GPU            []GPUStatus       // GPU状态
    Memory         MemoryStatus      // 内存状态
    Disks          []DiskStatus      // 磁盘状态
    DiskIO         DiskIOStatus      // 磁盘I/O
    Network        []NetworkStatus   // 网络状态
    NetworkHistory NetworkHistory    // 网络历史
    Proxy          ProxyStatus       // 代理状态
    Batteries      []BatteryStatus   // 电池状态
    Thermal        ThermalStatus     // 温度状态
    Sensors        []SensorReading   // 传感器读数
    Bluetooth      []BluetoothDevice // 蓝牙设备
}
```

## 监控指标

### 1. 系统信息

**显示内容**：
```
Mole Status  Health ● 92  MacBook Pro · M4 Pro · 32GB · macOS 14.5
```

**包含信息**：
- 健康分数：0-100
- 设备型号：MacBook Pro/Air/iMac等
- CPU型号：M1/M2/M3/M4/Intel
- 内存容量：总内存大小
- 系统版本：macOS版本号

**颜色编码**：
- 绿色（90-100）：优秀
- 黄色（70-89）：良好
- 橙色（50-69）：一般
- 红色（0-49）：差

### 2. CPU监控

**显示内容**：
```
⚙ CPU
Total   ████████████░░░░░░░  45.2%
Load    0.82 / 1.05 / 1.23 (8 cores)
Core 1  ███████████████░░░░  78.3%
Core 2  ████████████░░░░░░░  62.1%
Core 3  ██████████░░░░░░░░░  48.5%
...
```

**监控指标**：
- 总体使用率：所有核心平均
- 负载平均：1分钟/5分钟/15分钟
- 每核心使用率：单独显示每个核心
- 核心数：物理核心和逻辑核心

**数据来源**：
```go
cpu.Percent(time.Second, false)  // 总体使用率
cpu.Percent(time.Second, true)   // 每核心使用率
load.Avg()                       // 负载平均
```

### 3. GPU监控

**显示内容**：
```
🎮 GPU
GPU 0   ████████░░░░░░░░░░░  38.5%  Apple M4 Pro
Temp    45°C
Memory  2.1 / 16.0 GB
```

**监控指标**：
- GPU使用率：计算负载
- 温度：GPU温度
- 显存：已用/总显存
- GPU型号：芯片型号

**数据来源**：
- macOS：使用 `ioreg` 和 `powermetrics`
- 需要sudo权限获取详细信息

### 4. 内存监控

**显示内容**：
```
▦ Memory
Used    ███████████░░░░░░░  58.4%
Total   14.2 / 24.0 GB
Free    ████████░░░░░░░░░░  41.6%
Avail   9.8 GB
```

**监控指标**：
- 已用内存：实际使用的内存
- 总内存：物理内存总量
- 可用内存：可立即使用的内存
- 使用率：已用/总内存

**数据来源**：
```go
mem.VirtualMemory()
```

**内存类型**（macOS）：
- Wired：系统核心占用
- Active：活跃使用
- Inactive：非活跃但缓存
- Free：完全空闲

### 5. 磁盘监控

**显示内容**：
```
▤ Disk
Used    █████████████░░░░░░  67.2%
Free    156.3 GB
Read    ▮▯▯▯▯  2.1 MB/s
Write   ▮▮▮▯▯  18.3 MB/s
```

**监控指标**：
- 磁盘使用率：已用/总容量
- 可用空间：剩余空间
- 读取速度：实时读取速度
- 写入速度：实时写入速度

**数据来源**：
```go
disk.Usage("/")           // 磁盘使用情况
disk.IOCounters()         // I/O统计
```

**I/O速度计算**：
- 采样间隔：1秒
- 计算方式：(当前字节数 - 上次字节数) / 时间间隔

### 6. 网络监控

**显示内容**：
```
⇅ Network
Down    ▁▁█▂▁▁▁▁▁▁▁▁▇▆▅▂  0.54 MB/s
Up      ▄▄▄▃▃▃▄▆▆▇█▁▁▁▁▁  0.02 MB/s
Proxy   HTTP · 192.168.1.100
```

**监控指标**：
- 下载速度：实时下载速度
- 上传速度：实时上传速度
- 速度历史：迷你图显示历史趋势
- 代理状态：HTTP/HTTPS/SOCKS代理

**数据来源**：
```go
net.IOCounters(false)     // 网络I/O统计
```

**代理检测**：
- 读取系统代理设置
- 检测HTTP_PROXY环境变量
- 检测HTTPS_PROXY环境变量
- 检测SOCKS代理

**历史数据**：
- 环形缓冲区：保留最近60秒
- 迷你图：16个字符宽度
- 自动缩放：根据最大值调整

### 7. 电池监控

**显示内容**：
```
⚡ Power
Level   ██████████████████  100%
Status  Charged
Health  Normal · 423 cycles
Temp    58°C · 1200 RPM
```

**监控指标**：
- 电量：当前电量百分比
- 状态：充电中/已充满/放电中
- 健康状态：正常/需要维修
- 循环次数：充电循环次数
- 温度：电池温度
- 风扇转速：散热风扇RPM

**数据来源**：
```go
host.SensorsTemperatures()  // 温度传感器
```

**macOS特定**：
- 使用 `ioreg` 获取电池信息
- 使用 `pmset -g batt` 获取电量
- 使用 `smc` 工具获取温度和风扇

### 8. 进程监控

**显示内容**：
```
▶ Processes
Code       ▮▮▮▮▯  42.1%
Chrome     ▮▮▮▯▯  28.3%
Terminal   ▮▯▯▯▯  12.5%
```

**监控指标**：
- Top 3进程：CPU使用率最高的进程
- 进程名称：应用名称
- CPU占用：单个进程的CPU使用率

**数据来源**：
```go
process.Processes()       // 所有进程
proc.CPUPercent()         // 进程CPU使用率
```

## 健康评分算法

### 评分维度

1. **CPU负载（25分）**
   - <50%：25分
   - 50-70%：20分
   - 70-85%：15分
   - >85%：10分

2. **内存使用（25分）**
   - <60%：25分
   - 60-75%：20分
   - 75-85%：15分
   - >85%：10分

3. **磁盘空间（20分）**
   - >30%可用：20分
   - 20-30%可用：15分
   - 10-20%可用：10分
   - <10%可用：5分

4. **磁盘I/O（15分）**
   - <50 MB/s：15分
   - 50-100 MB/s：12分
   - 100-200 MB/s：8分
   - >200 MB/s：5分

5. **温度（15分）**
   - <60°C：15分
   - 60-75°C：12分
   - 75-85°C：8分
   - >85°C：5分

### 评分等级

- **90-100分**：优秀（绿色）
  - 系统运行流畅
  - 资源充足
  - 无性能瓶颈

- **70-89分**：良好（黄色）
  - 系统运行正常
  - 资源使用合理
  - 可能有轻微瓶颈

- **50-69分**：一般（橙色）
  - 系统有压力
  - 资源紧张
  - 建议优化

- **0-49分**：差（红色）
  - 系统严重负载
  - 资源耗尽
  - 需要立即处理

## 交互操作

### 键盘快捷键
- `Q/Esc/Ctrl+C`：退出
- `K`：切换猫咪可见性（彩蛋）
- 自动刷新：每秒更新

### 猫咪动画
- 根据CPU使用率调整动画速度
- 可以按K键切换显示/隐藏
- 偏好保存在 `~/.config/mole/status_prefs`

## 使用方式

### 基础用法
```bash
mo status                   # 启动系统监控
```

### 配置文件
位置：`~/.config/mole/status_prefs`

格式：
```json
{
  "show_cat": true
}
```

## 性能优化

### 采集优化
- 采样间隔：1秒
- 并发采集：所有指标并行采集
- 缓存结果：避免重复计算

### 渲染优化
- 增量渲染：只更新变化的部分
- 防抖动：限制刷新频率
- 虚拟终端：使用Bubble Tea优化

### 内存优化
- 环形缓冲区：限制历史数据大小
- 及时释放：清理过期数据

## 常见问题

### Q: 为什么有些指标显示不准确？
A: 可能是：
1. 权限不足（需要sudo）
2. 系统API限制
3. 采样间隔太短

### Q: 为什么GPU信息显示不全？
A: macOS限制了GPU信息访问，需要sudo权限。

### Q: 健康分数是如何计算的？
A: 综合CPU、内存、磁盘、I/O、温度五个维度。

### Q: 可以导出监控数据吗？
A: 当前版本不支持，未来版本会添加。

## Mac应用开发建议

### UI设计

1. **仪表板界面**
   - 使用原生NSView绘制图表
   - 使用Core Animation实现动画
   - 使用NSStackView布局

2. **图表类型**
   - 折线图：显示历史趋势
   - 条形图：显示当前使用率
   - 饼图：显示资源分布
   - 仪表盘：显示健康分数

3. **实时更新**
   - 使用NSTimer定时刷新
   - 使用DispatchQueue后台采集
   - 使用NSAnimationContext平滑过渡

### 功能增强

1. **历史记录**
   - 记录历史数据
   - 支持查看历史趋势
   - 支持导出数据

2. **告警功能**
   - CPU使用率过高告警
   - 内存不足告警
   - 磁盘空间不足告警
   - 温度过高告警

3. **菜单栏图标**
   - 显示CPU使用率
   - 显示内存使用率
   - 显示网络速度
   - 点击显示详细信息

4. **通知中心**
   - 性能问题通知
   - 资源不足通知
   - 系统更新通知

5. **导出功能**
   - 导出监控报告
   - 导出性能数据
   - 导出图表截图

### 技术实现

1. **数据采集**
   - 使用IOKit获取硬件信息
   - 使用sysctl获取系统信息
   - 使用task_info获取进程信息
   - 使用IOServiceGetMatchingServices获取传感器

2. **图表绘制**
   - 使用Core Graphics绘制
   - 使用Core Animation动画
   - 使用Metal加速（可选）

3. **性能优化**
   - 使用GCD并发采集
   - 使用NSCache缓存数据
   - 使用增量更新减少重绘

4. **菜单栏集成**
   - 使用NSStatusItem创建菜单栏图标
   - 使用NSPopover显示详细信息
   - 使用NSMenu创建右键菜单

### 参考实现

类似应用：
- iStat Menus：功能最全面
- MenuMeters：开源实现
- Stats：现代化设计
- Activity Monitor：系统自带

### 开发建议

1. **先实现核心功能**：数据采集、显示
2. **再优化性能**：并发、缓存、增量更新
3. **最后增强体验**：动画、图表、交互

4. **注意事项**：
   - 权限管理：某些API需要特殊权限
   - 性能影响：避免过度采集影响系统
   - 兼容性：不同macOS版本API可能不同
   - 错误处理：处理API调用失败的情况
