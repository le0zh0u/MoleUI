# Mole 技术架构文档

## 架构概览

Mole 采用混合架构设计，结合了 Shell 脚本的灵活性和 Go 语言的高性能，提供了一个安全、高效的 macOS 系统管理工具。

## 技术栈

### 核心技术
- **Shell (Bash 5.x)**：主要命令实现、系统交互
- **Go (1.21+)**：高性能模块（analyze, status）
- **Swift (5.x)**：原生 macOS UI（MoleUI）

### Go 依赖库
```go
// TUI框架
github.com/charmbracelet/bubbletea
github.com/charmbracelet/lipgloss

// 系统信息
github.com/shirou/gopsutil/v3

// 并发控制
golang.org/x/sync/singleflight
```

## 项目结构

```
Mole/
├── bin/                    # 命令入口脚本
│   ├── clean.sh           # 深度清理
│   ├── uninstall.sh       # 应用卸载
│   ├── optimize.sh        # 系统优化
│   ├── analyze.sh         # 磁盘分析（Go包装）
│   ├── status.sh          # 系统监控（Go包装）
│   ├── purge.sh           # 项目清理
│   └── installer.sh       # 安装包清理
│
├── cmd/                    # Go 源代码
│   ├── analyze/           # 磁盘分析器
│   │   ├── main.go        # 主入口
│   │   ├── scanner.go     # 并发扫描引擎
│   │   ├── cache.go       # 缓存系统
│   │   ├── view.go        # TUI视图
│   │   ├── delete.go      # 删除操作
│   │   ├── heap.go        # 最小堆（大文件）
│   │   └── format.go      # 格式化工具
│   │
│   └── status/            # 系统监控
│       ├── main.go        # 主入口
│       ├── metrics.go     # 指标采集
│       ├── metrics_*.go   # 各类指标实现
│       └── view.go        # TUI视图
│
├── lib/                    # Shell 库模块
│   ├── core/              # 核心功能
│   │   ├── base.sh        # 基础定义
│   │   ├── file_ops.sh    # 文件操作
│   │   ├── sudo.sh        # sudo管理
│   │   ├── log.sh         # 日志记录
│   │   └── ui.sh          # UI组件
│   │
│   ├── clean/             # 清理模块
│   │   ├── system.sh      # 系统清理
│   │   ├── user.sh        # 用户清理
│   │   ├── dev.sh         # 开发工具清理
│   │   ├── app_caches.sh  # 应用缓存清理
│   │   ├── apps.sh        # 应用相关清理
│   │   └── project.sh     # 项目清理
│   │
│   ├── manage/            # 管理功能
│   │   ├── whitelist.sh   # 白名单管理
│   │   ├── autofix.sh     # 自动修复
│   │   └── update.sh      # 更新管理
│   │
│   ├── optimize/          # 优化功能
│   │   └── tasks.sh       # 优化任务
│   │
│   ├── uninstall/         # 卸载功能
│   │   └── scanner.sh     # 应用扫描
│   │
│   └── ui/                # UI组件
│       ├── menu_paginated.sh  # 分页菜单
│       └── app_selector.sh    # 应用选择器
│
├── MoleUI/                # Swift UI 应用
│   └── (Xcode项目)
│
└── scripts/               # 辅助脚本
    └── setup-quick-launchers.sh
```

## 核心设计模式

### 1. 模块化设计

**Shell 模块**：
```bash
# 加载核心库
source "${MOLE_LIB_DIR}/core/base.sh"
source "${MOLE_LIB_DIR}/core/file_ops.sh"

# 加载功能模块
source "${MOLE_LIB_DIR}/clean/system.sh"
```

**优点**：
- 代码复用
- 易于维护
- 功能隔离

### 2. 并发处理

**Shell 并发**：
```bash
# 后台任务 + 等待
for item in "${items[@]}"; do
    process_item "$item" &

    # 控制并发数
    if (( $(jobs -r | wc -l) >= MAX_JOBS )); then
        wait -n
    fi
done
wait
```

**Go 并发**：
```go
// Worker Pool 模式
numWorkers := runtime.NumCPU() * 2
jobs := make(chan string, numWorkers)
results := make(chan result, numWorkers)

for i := 0; i < numWorkers; i++ {
    go worker(jobs, results)
}
```

### 3. 缓存策略

**多层缓存**：
1. **内存缓存**：LRU缓存，快速访问
2. **磁盘缓存**：持久化，跨会话
3. **Stale缓存**：过期但可用的回退

**缓存实现**：
```go
type cacheEntry struct {
    Data      interface{}
    Timestamp time.Time
    TTL       time.Duration
}

func (c *Cache) Get(key string) (interface{}, bool) {
    entry, ok := c.data[key]
    if !ok {
        return nil, false
    }

    if time.Since(entry.Timestamp) > entry.TTL {
        // 尝试使用stale cache
        return entry.Data, true
    }

    return entry.Data, true
}
```

### 4. 错误处理

**Shell 错误处理**：
```bash
# 启用严格模式
set -euo pipefail

# 错误捕获
trap 'handle_error $? $LINENO' ERR

handle_error() {
    local exit_code=$1
    local line_number=$2
    log_error "Error at line $line_number: exit code $exit_code"
    cleanup
    exit "$exit_code"
}
```

**Go 错误处理**：
```go
func scanPath(path string) (result, error) {
    if err := validatePath(path); err != nil {
        return result{}, fmt.Errorf("invalid path: %w", err)
    }

    // 操作...

    return result, nil
}
```

### 5. 安全机制

**路径验证**：
```bash
validate_path_for_deletion() {
    local path="$1"

    # 检查空路径
    [[ -z "$path" ]] && return 1

    # 检查系统保护路径
    case "$path" in
        /System*|/bin*|/sbin*|/usr*|/etc*|/var/db*)
            return 1
            ;;
    esac

    # 检查路径遍历
    [[ "$path" =~ \.\./  ]] && return 1

    # 检查控制字符
    [[ "$path" =~ [[:cntrl:]] ]] && return 1

    return 0
}
```

**权限管理**：
```bash
# sudo 会话管理
request_sudo_if_needed() {
    if ! sudo -n true 2>/dev/null; then
        echo "需要管理员权限..."
        sudo -v

        # 保持会话活跃
        while true; do
            sudo -n true
            sleep 60
            kill -0 "$$" || exit
        done 2>/dev/null &
    fi
}
```

## 性能优化

### 1. 并发优化

**动态并发数**：
```bash
get_optimal_parallel_jobs() {
    local operation_type="${1:-default}"
    local cpu_cores=$(sysctl -n hw.ncpu)

    case "$operation_type" in
        scan|io)
            echo $((cpu_cores * 2))  # I/O密集
            ;;
        compute)
            echo "$cpu_cores"         # CPU密集
            ;;
        *)
            echo $((cpu_cores + 2))   # 默认
            ;;
    esac
}
```

### 2. 内存优化

**流式处理**：
```go
// 不加载所有文件到内存
func scanDirectory(path string) error {
    return filepath.Walk(path, func(path string, info os.FileInfo, err error) error {
        if err != nil {
            return err
        }

        // 处理单个文件
        processFile(path, info)

        return nil
    })
}
```

**最小堆**：
```go
// 只保留 Top N 大文件
type MinHeap []fileEntry

func (h *MinHeap) Push(x interface{}) {
    *h = append(*h, x.(fileEntry))
    if len(*h) > maxFiles {
        heap.Pop(h)
    }
}
```

### 3. I/O 优化

**批量操作**：
```bash
# 批量删除
find "$dir" -type f -name "*.log" -print0 | xargs -0 rm -f
```

**缓冲读写**：
```go
// 使用缓冲
writer := bufio.NewWriter(file)
defer writer.Flush()
```

### 4. 超时保护

**命令超时**：
```bash
run_with_timeout() {
    local timeout="$1"
    shift
    timeout "$timeout" "$@"
}

# 使用
run_with_timeout 10 mdfind "kMDItemKind == 'Application'"
```

**Go 超时**：
```go
ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
defer cancel()

select {
case result := <-resultChan:
    return result, nil
case <-ctx.Done():
    return nil, ctx.Err()
}
```

## 数据流

### Clean 命令流程
```
用户输入
  ↓
bin/clean.sh
  ↓
加载配置和白名单
  ↓
并发扫描各个类别
  ├─ lib/clean/system.sh
  ├─ lib/clean/user.sh
  ├─ lib/clean/dev.sh
  └─ lib/clean/app_caches.sh
  ↓
应用白名单过滤
  ↓
显示清理计划
  ↓
用户确认
  ↓
执行删除（并发）
  ↓
记录日志
  ↓
显示结果
```

### Analyze 命令流程
```
用户输入
  ↓
bin/analyze.sh
  ↓
启动 Go 二进制
  ↓
cmd/analyze/main.go
  ↓
检查缓存
  ├─ 命中 → 使用缓存
  └─ 未命中 → 扫描
      ↓
  并发扫描（Worker Pool）
      ├─ 扫描目录
      ├─ 计算大小
      └─ 检测大文件
      ↓
  保存缓存
  ↓
显示 TUI 界面
  ↓
用户交互
  ├─ 导航
  ├─ 删除
  ├─ 打开
  └─ 刷新
```

## 配置管理

### 配置文件位置
```
~/.config/mole/
├── whitelist                    # 清理白名单
├── whitelist_optimize           # 优化白名单
├── purge_paths                  # 项目清理路径
├── status_prefs                 # 状态偏好
├── operations.log               # 操作日志
└── mole_debug_session.log       # 调试日志

~/.cache/mole/
├── uninstall_app_metadata_v1    # 应用元数据缓存
├── analyze_*                    # 磁盘分析缓存
└── overview_*                   # 概览缓存
```

### 环境变量
```bash
# 调试模式
MO_DEBUG=1

# 禁用操作日志
MO_NO_OPLOG=1

# 分析路径
MO_ANALYZE_PATH=/path

# 干运行模式
MOLE_DRY_RUN=1

# 测试模式
MOLE_TEST_MODE=1

# 启动器应用
MO_LAUNCHER_APP=Alacritty
```

## 日志系统

### 操作日志
```bash
# 格式
[timestamp] [command] [action] [path] [details]

# 示例
[2024-01-15 10:30:45] [clean] [delete] [~/Library/Caches/com.apple.Safari] [2.3GB]
[2024-01-15 10:31:12] [uninstall] [delete] [/Applications/Photoshop.app] [4.2GB]
```

### 调试日志
```bash
# 启用
mo clean --debug

# 内容
- 风险级别
- 文件详情
- 操作流程
- 错误信息
- 性能统计
```

## 测试策略

### Shell 测试
```bash
# 单元测试
test_validate_path() {
    validate_path_for_deletion "/System" && fail "Should reject /System"
    validate_path_for_deletion "/tmp/test" || fail "Should accept /tmp/test"
}

# 集成测试
test_clean_dry_run() {
    MOLE_DRY_RUN=1 mo clean
    # 验证没有文件被删除
}
```

### Go 测试
```go
func TestScanPath(t *testing.T) {
    result, err := scanPath("/tmp/test")
    if err != nil {
        t.Fatalf("scanPath failed: %v", err)
    }

    if result.TotalSize == 0 {
        t.Error("Expected non-zero size")
    }
}
```

## 部署和分发

### 编译
```bash
# Go 二进制
make build

# 输出
bin/analyze
bin/status
```

### 安装
```bash
# Homebrew
brew install mole

# 脚本安装
curl -fsSL https://raw.githubusercontent.com/tw93/mole/main/install.sh | bash
```

### 更新
```bash
# 自动更新
mo update

# 手动更新
brew upgrade mole
```

## 安全审计

### 代码审计
- 路径验证
- 权限检查
- 输入验证
- 错误处理

### 运行时保护
- 白名单机制
- 干运行模式
- 操作日志
- 超时保护

### 用户保护
- 确认机制
- 风险提示
- 撤销功能（部分）
- 备份建议

## 性能指标

### 扫描性能
- Clean扫描：5-10秒
- Analyze扫描：10-30秒（取决于文件数）
- Status刷新：1秒

### 内存占用
- Clean：~20MB
- Analyze：~50MB
- Status：~30MB

### CPU占用
- 扫描阶段：50-80%
- 显示阶段：5-10%
- 空闲阶段：<1%

## 兼容性

### macOS 版本
- 最低：macOS 11 (Big Sur)
- 推荐：macOS 13+ (Ventura+)
- 测试：macOS 14 (Sonoma)

### 芯片架构
- Intel (x86_64)
- Apple Silicon (arm64)
- Universal Binary

### 终端兼容性
- ✓ Alacritty
- ✓ kitty
- ✓ WezTerm
- ✓ Ghostty
- ✓ Warp
- ⚠ iTerm2（已知问题）
- ✓ Terminal.app

## 未来优化方向

### 性能优化
1. 增量扫描：只扫描变化的部分
2. 智能缓存：更智能的缓存策略
3. 并行优化：更好的并发控制

### 功能增强
1. 机器学习：智能推荐清理
2. 定时任务：自动定期清理
3. 云同步：配置云同步

### 用户体验
1. 图形界面：原生 macOS 应用
2. 通知中心：系统通知集成
3. 菜单栏：菜单栏图标

## 参考资料

### 技术文档
- [Bubble Tea](https://github.com/charmbracelet/bubbletea)
- [gopsutil](https://github.com/shirou/gopsutil)
- [Bash Reference Manual](https://www.gnu.org/software/bash/manual/)

### 类似项目
- CleanMyMac
- AppCleaner
- DaisyDisk
- iStat Menus
