# Installer - 安装包清理功能

## 功能概述

查找并删除散落在系统各处的安装程序文件（.dmg, .pkg, .iso等），帮助用户回收被遗忘的磁盘空间。

## 核心价值

- **空间回收**：通常可回收 2-10GB
- **全面扫描**：覆盖所有常见位置
- **智能识别**：自动识别安装程序文件
- **源位置标记**：显示文件来源

## 支持的文件类型

### 1. 磁盘镜像
- `.dmg` - macOS磁盘镜像
- `.iso` - ISO镜像文件

**典型大小**：500MB - 8GB

**常见来源**：
- 应用安装程序
- 系统安装镜像
- 虚拟机镜像

### 2. 安装包
- `.pkg` - macOS安装包
- `.mpkg` - 多包安装器

**典型大小**：100MB - 2GB

**常见来源**：
- 系统更新
- 应用安装程序
- 驱动程序

### 3. 压缩包
- `.xip` - Xcode压缩包
- `.zip` - ZIP压缩包（包含.app/.pkg/.dmg）

**典型大小**：500MB - 10GB

**常见来源**：
- Xcode安装包
- 应用程序包
- 开发工具

## 扫描位置

### 1. 用户目录
- `~/Downloads` - 下载文件夹
- `~/Desktop` - 桌面
- `~/Documents` - 文档
- `~/Library/Downloads` - 库下载

**优先级**：高
**典型文件数**：10-50个

### 2. 共享目录
- `/Users/Shared` - 共享文件夹

**优先级**：中
**典型文件数**：0-10个

### 3. Homebrew缓存
- `~/Library/Caches/Homebrew/downloads` - Homebrew下载缓存
- `~/Library/Caches/Homebrew/Cask` - Homebrew Cask缓存

**优先级**：高
**典型文件数**：5-30个

### 4. iCloud
- `~/Library/Mobile Documents/com~apple~CloudDocs/Downloads` - iCloud下载

**优先级**：中
**典型文件数**：0-20个

### 5. Mail附件
- `~/Library/Mail/V*/Mail Downloads` - Mail下载附件

**优先级**：低
**典型文件数**：0-10个

**大小阈值**：5MB（跳过小文件）

### 6. Telegram
- `~/Library/Group Containers/*.TelegramDesktop/Downloads` - Telegram下载

**优先级**：中
**典型文件数**：0-20个

## 使用方式

### 基础用法
```bash
mo installer                # 扫描并清理安装包
```

### 交互界面
```
Select Installers to Remove - 3.8GB (5 selected)

➤ ● Photoshop_2024.dmg     1.2GB | Downloads
  ● IntelliJ_IDEA.dmg       850.6MB | Downloads
  ● Illustrator_Setup.pkg   920.4MB | Downloads
  ● PyCharm_Pro.dmg         640.5MB | Homebrew
  ● Acrobat_Reader.dmg      220.4MB | Downloads
  ○ AppCode_Legacy.zip      410.6MB | Downloads
```

**显示信息**：
- 文件名
- 文件大小
- 源位置（Downloads, Desktop, Homebrew等）
- 选中状态

### 操作
- `↑↓/jk`：上下移动
- `Space`：选中/取消选中
- `A`：全选
- `I`：反选
- `Enter`：确认删除
- `Q/Esc`：退出

## ZIP文件检查

### 检查逻辑
只有包含以下内容的ZIP才会被识别为安装包：
- `.app` - 应用程序包
- `.pkg` - 安装包
- `.dmg` - 磁盘镜像

### 检查范围
- 检查前50个条目
- 跳过嵌套目录
- 超时保护：5秒

### 示例
```
✓ MyApp.zip (包含 MyApp.app)
✓ Installer.zip (包含 setup.pkg)
✗ Documents.zip (只包含文档)
✗ Photos.zip (只包含图片)
```

## 安全机制

### 文件验证
- 验证文件存在
- 验证文件可读
- 验证文件大小

### 路径验证
- 只扫描标准位置
- 不扫描系统目录
- 不扫描应用程序包内部

### 确认机制
- 显示将要删除的文件数量
- 显示将要回收的空间
- 需要用户明确确认

### 删除方式
- 直接删除（不移至垃圾箱）
- 永久删除
- 记录日志

## 扫描流程

1. **扫描阶段**
   - 并行扫描所有位置
   - 识别文件类型
   - 检查ZIP内容
   - 计算文件大小

2. **过滤阶段**
   - 跳过小于5MB的Mail附件
   - 跳过不包含安装内容的ZIP
   - 去重（相同路径）

3. **显示阶段**
   - 按大小排序
   - 显示源位置
   - 显示总可回收空间

4. **用户选择**
   - 支持多选
   - 支持全选/反选
   - 默认全选

5. **执行删除**
   - 按顺序删除
   - 显示进度
   - 记录日志

6. **显示结果**
   - 显示删除结果
   - 显示回收空间

## 性能优化

### 并发扫描
- 最多15个并行任务
- 按位置并行扫描
- 智能任务调度

### 快速识别
- 使用文件扩展名快速过滤
- 缓存ZIP检查结果
- 跳过符号链接

### 超时保护
- ZIP检查：5秒超时
- 网络卷检查：5秒超时
- 单个位置扫描：30秒超时

## 日志记录

位置：`~/.config/mole/operations.log`

格式：
```
[timestamp] [installer] [delete] [path] [size]
```

## 常见问题

### Q: 删除后还能安装应用吗？
A: 如果应用已经安装，删除安装包不影响使用。如果需要重新安装，可以重新下载。

### Q: 会删除正在使用的文件吗？
A: 不会。只删除安装程序文件，不删除已安装的应用。

### Q: 可以恢复吗？
A: 不能。删除是永久的，不移至垃圾箱。

### Q: 为什么有些安装包找不到？
A: 可能是：
1. 文件在非标准位置
2. 文件已经被删除
3. 文件在外部驱动器上

### Q: ZIP文件为什么没有被识别？
A: 可能是：
1. ZIP不包含安装内容
2. ZIP检查超时
3. ZIP文件损坏

## Mac应用开发建议

### UI设计

1. **扫描界面**
   - 显示扫描进度
   - 显示当前扫描的位置
   - 显示已找到的文件数
   - 支持取消扫描

2. **文件列表界面**
   - 使用NSTableView显示文件列表
   - 显示文件图标（根据类型）
   - 显示文件大小和位置
   - 支持排序（按大小、名称、位置）
   - 支持搜索过滤

3. **文件预览**
   - 使用Quick Look预览文件
   - 显示文件详细信息
   - 显示文件路径

4. **删除进度界面**
   - 显示删除进度
   - 显示当前操作
   - 显示已回收空间

5. **结果界面**
   - 显示删除结果
   - 显示回收空间
   - 支持查看日志

### 功能增强

1. **智能推荐**
   - 推荐旧的安装包
   - 推荐大型安装包
   - 推荐已安装应用的安装包

2. **自动清理**
   - 支持定期自动清理
   - 支持设置清理规则
   - 支持通知提醒

3. **位置分组**
   - 按位置分组显示
   - 按类型分组显示
   - 按大小分组显示

4. **统计分析**
   - 显示文件类型分布
   - 显示位置分布
   - 显示清理历史

5. **自定义扫描**
   - 支持添加自定义扫描位置
   - 支持自定义文件类型
   - 支持自定义大小阈值

### 技术实现

1. **文件扫描**
   - 使用FileManager枚举文件
   - 使用NSPredicate过滤文件
   - 使用DispatchQueue并发扫描

2. **ZIP检查**
   - 使用ZipArchive读取ZIP内容
   - 使用NSFileManager检查文件类型
   - 使用超时保护

3. **文件删除**
   - 使用FileManager删除文件
   - 使用NSFileManager移至垃圾箱（可选）
   - 使用DispatchQueue后台删除

4. **图标获取**
   - 使用NSWorkspace获取文件图标
   - 使用NSImage缓存图标

### 用户体验优化

1. **快速扫描**
   - 使用并发加速扫描
   - 显示实时进度
   - 支持取消扫描

2. **智能选择**
   - 默认全选
   - 支持一键全选/反选
   - 支持按位置选择

3. **安全提示**
   - 提示将要删除的内容
   - 提示删除是永久的
   - 提示如何重新下载

4. **通知反馈**
   - 扫描完成后发送通知
   - 删除完成后发送通知
   - 显示回收空间

### 参考实现

类似功能：
- CleanMyMac：包含安装包清理
- AppCleaner：专注应用清理
- 手动清理：在Finder中搜索.dmg文件

### 开发建议

1. **先实现核心功能**：扫描、识别、删除
2. **再优化性能**：并发、缓存
3. **最后增强体验**：智能推荐、统计分析

4. **注意事项**：
   - 权限管理：某些位置可能需要特殊权限
   - 错误处理：处理删除失败的情况
   - 用户确认：删除前必须确认
   - 日志记录：记录所有操作
   - ZIP检查：注意超时和错误处理
