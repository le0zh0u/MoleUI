# MoleUI - Mac 应用开发计划

## 项目概述

**重要说明**：MoleUI 是一个完全独立的 Swift 原生应用，不依赖 Mole CLI 的任何代码。

MoleUI 将为普通用户提供友好的图形界面，实现与 Mole CLI 相同的功能，但使用 Swift 完全重新实现。我们将学习 Mole CLI 的业务逻辑和最佳实践，但所有代码都将用 Swift 从零编写。

## 开发目标

### 核心目标
1. **功能完整**：实现 Mole CLI 的所有功能（用 Swift 重新实现）
2. **用户友好**：提供直观的图形界面
3. **性能优异**：保持高性能和低资源占用
4. **原生体验**：遵循 macOS 设计规范
5. **独立运行**：无需安装 Mole CLI

### 目标用户
1. **普通用户**：不熟悉命令行的用户
2. **专业用户**：需要图形界面的高级功能
3. **开发者**：需要可视化工具的开发者

## 技术选型

### 开发语言
- **Swift 5.x**：主要开发语言
- **SwiftUI**：UI 框架
- **Combine**：响应式编程

### 系统框架
- **AppKit**：窗口管理、菜单栏
- **Foundation**：基础功能
- **IOKit**：硬件信息
- **SystemConfiguration**：系统配置

### 第三方库
```swift
// 依赖管理：Swift Package Manager

// 图表库
.package(url: "https://github.com/danielgindi/Charts.git", from: "5.0.0")

// 权限管理
.package(url: "https://github.com/sindresorhus/Defaults.git", from: "7.0.0")

// 日志
.package(url: "https://github.com/apple/swift-log.git", from: "1.5.0")
```

## 应用架构

### MVVM 架构
```
View (SwiftUI)
  ↓
ViewModel (ObservableObject)
  ↓
Model (Data + Business Logic)
  ↓
Service (System APIs)
```

### 模块划分
```
MoleUI/
├── App/
│   ├── MoleUIApp.swift           # 应用入口
│   └── AppDelegate.swift         # 应用代理
│
├── Views/                         # 视图层
│   ├── MainView.swift            # 主窗口
│   ├── SidebarView.swift         # 侧边栏
│   ├── Clean/
│   │   ├── CleanView.swift       # 清理界面
│   │   ├── CleanScanView.swift   # 扫描界面
│   │   └── CleanResultView.swift # 结果界面
│   ├── Uninstall/
│   │   ├── UninstallView.swift
│   │   └── AppListView.swift
│   ├── Optimize/
│   │   └── OptimizeView.swift
│   ├── Analyze/
│   │   ├── AnalyzeView.swift
│   │   └── DiskTreeView.swift
│   ├── Status/
│   │   ├── StatusView.swift
│   │   └── MetricsView.swift
│   ├── Purge/
│   │   └── PurgeView.swift
│   └── Installer/
│       └── InstallerView.swift
│
├── ViewModels/                    # 视图模型层
│   ├── CleanViewModel.swift
│   ├── UninstallViewModel.swift
│   ├── OptimizeViewModel.swift
│   ├── AnalyzeViewModel.swift
│   ├── StatusViewModel.swift
│   ├── PurgeViewModel.swift
│   └── InstallerViewModel.swift
│
├── Models/                        # 数据模型层
│   ├── CleanCategory.swift
│   ├── Application.swift
│   ├── DiskEntry.swift
│   ├── SystemMetrics.swift
│   ├── Project.swift
│   └── InstallerFile.swift
│
├── Services/                      # 服务层
│   ├── CleanService.swift        # 清理服务
│   ├── UninstallService.swift    # 卸载服务
│   ├── OptimizeService.swift     # 优化服务
│   ├── AnalyzeService.swift      # 分析服务
│   ├── StatusService.swift       # 监控服务
│   ├── PurgeService.swift        # 项目清理服务
│   └── InstallerService.swift    # 安装包清理服务
│
├── Core/                          # 核心功能
│   ├── FileManager+Extensions.swift
│   ├── Process+Extensions.swift
│   ├── PrivilegedHelper.swift    # 权限助手
│   ├── Logger.swift              # 日志
│   ├── Cache.swift               # 缓存
│   └── Config.swift              # 配置
│
├── Utils/                         # 工具类
│   ├── FormatUtils.swift         # 格式化
│   ├── PathUtils.swift           # 路径工具
│   ├── SecurityUtils.swift       # 安全工具
│   └── PerformanceUtils.swift    # 性能工具
│
└── Resources/                     # 资源文件
    ├── Assets.xcassets           # 图片资源
    ├── Localizable.strings       # 本地化
    └── Info.plist                # 应用配置
```

## 核心功能实现

### 1. Clean（深度清理）

#### 数据模型
```swift
struct CleanCategory: Identifiable {
    let id: UUID
    let name: String
    let description: String
    let icon: String
    var size: Int64
    var isSelected: Bool
    var riskLevel: RiskLevel
    var items: [CleanItem]
}

struct CleanItem {
    let path: String
    let size: Int64
    let lastModified: Date
}

enum RiskLevel {
    case low, medium, high
}
```

#### ViewModel
```swift
class CleanViewModel: ObservableObject {
    @Published var categories: [CleanCategory] = []
    @Published var isScanning: Bool = false
    @Published var scanProgress: Double = 0
    @Published var totalSize: Int64 = 0

    private let cleanService: CleanService

    func startScan() async {
        isScanning = true
        categories = await cleanService.scanCategories { progress in
            self.scanProgress = progress
        }
        isScanning = false
    }

    func clean() async throws {
        let selectedCategories = categories.filter { $0.isSelected }
        try await cleanService.clean(selectedCategories)
    }
}
```

#### Service
```swift
class CleanService {
    func scanCategories(progress: @escaping (Double) -> Void) async -> [CleanCategory] {
        // 并发扫描各个类别
        await withTaskGroup(of: CleanCategory.self) { group in
            for category in allCategories {
                group.addTask {
                    await self.scanCategory(category, progress: progress)
                }
            }

            var results: [CleanCategory] = []
            for await category in group {
                results.append(category)
            }
            return results
        }
    }

    func clean(_ categories: [CleanCategory]) async throws {
        for category in categories {
            for item in category.items {
                try await deleteFile(item.path)
            }
        }
    }

    private func deleteFile(_ path: String) async throws {
        // 使用 FileManager 删除文件
        try FileManager.default.removeItem(atPath: path)
    }
}
```

### 2. Uninstall（智能卸载）

#### 数据模型
```swift
struct Application: Identifiable {
    let id: UUID
    let name: String
    let bundleID: String
    let path: String
    let icon: NSImage
    let size: Int64
    let lastUsed: Date
    var relatedFiles: [String]
}
```

#### ViewModel
```swift
class UninstallViewModel: ObservableObject {
    @Published var applications: [Application] = []
    @Published var isScanning: Bool = false
    @Published var selectedApps: Set<UUID> = []

    func scanApplications() async {
        isScanning = true
        applications = await uninstallService.scanApplications()
        isScanning = false
    }

    func uninstall() async throws {
        let apps = applications.filter { selectedApps.contains($0.id) }
        try await uninstallService.uninstall(apps)
    }
}
```

### 3. Analyze（磁盘分析）

#### 数据模型
```swift
struct DiskEntry: Identifiable {
    let id: UUID
    let name: String
    let path: String
    let size: Int64
    let isDirectory: Bool
    let lastAccess: Date
    var children: [DiskEntry]?
}
```

#### ViewModel
```swift
class AnalyzeViewModel: ObservableObject {
    @Published var currentPath: String = ""
    @Published var entries: [DiskEntry] = []
    @Published var isScanning: Bool = false
    @Published var totalSize: Int64 = 0

    func scan(path: String) async {
        isScanning = true
        currentPath = path
        entries = await analyzeService.scan(path)
        totalSize = entries.reduce(0) { $0 + $1.size }
        isScanning = false
    }

    func delete(_ entry: DiskEntry) async throws {
        try await analyzeService.delete(entry.path)
        await scan(path: currentPath)
    }
}
```

### 4. Status（系统监控）

#### 数据模型
```swift
struct SystemMetrics {
    let timestamp: Date
    let cpu: CPUMetrics
    let memory: MemoryMetrics
    let disk: DiskMetrics
    let network: NetworkMetrics
    let battery: BatteryMetrics?
}

struct CPUMetrics {
    let usage: Double
    let loadAverage: (Double, Double, Double)
    let coreUsages: [Double]
}
```

#### ViewModel
```swift
class StatusViewModel: ObservableObject {
    @Published var metrics: SystemMetrics?
    @Published var history: [SystemMetrics] = []

    private var timer: Timer?

    func startMonitoring() {
        timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { _ in
            Task {
                await self.updateMetrics()
            }
        }
    }

    func stopMonitoring() {
        timer?.invalidate()
        timer = nil
    }

    private func updateMetrics() async {
        metrics = await statusService.collectMetrics()
        history.append(metrics!)
        if history.count > 60 {
            history.removeFirst()
        }
    }
}
```

## UI 设计

### 主窗口布局
```
┌─────────────────────────────────────────────────┐
│  Mole                                    ● ● ●  │
├──────────┬──────────────────────────────────────┤
│          │                                      │
│  Clean   │                                      │
│  Uninstall│         主内容区域                   │
│  Optimize│                                      │
│  Analyze │                                      │
│  Status  │                                      │
│  Purge   │                                      │
│  Installer│                                     │
│          │                                      │
│          │                                      │
├──────────┴──────────────────────────────────────┤
│  状态栏：空间信息、操作提示                        │
└─────────────────────────────────────────────────┘
```

### 颜色方案
```swift
extension Color {
    static let moleBackground = Color(nsColor: .windowBackgroundColor)
    static let moleSidebar = Color(nsColor: .controlBackgroundColor)
    static let moleAccent = Color.blue
    static let moleSuccess = Color.green
    static let moleWarning = Color.orange
    static let moleDanger = Color.red
}
```

### 图标设计
- 使用 SF Symbols
- 自定义应用图标
- 支持深色模式

## 权限管理

### 需要的权限
1. **完全磁盘访问权限**：读取所有文件
2. **管理员权限**：删除系统文件
3. **辅助功能权限**：某些系统操作

### 权限请求流程
```swift
class PermissionManager {
    func requestFullDiskAccess() -> Bool {
        // 检查权限
        let testPath = "/Library/Application Support"
        return FileManager.default.isReadableFile(atPath: testPath)
    }

    func requestAdminPrivileges() async throws {
        // 使用 SMJobBless 请求权限
        try await installPrivilegedHelper()
    }

    private func installPrivilegedHelper() async throws {
        // 安装特权助手
        // 使用 SMJobBless API
    }
}
```

### 特权助手
```swift
// PrivilegedHelper.swift
class PrivilegedHelper: NSObject, NSXPCListenerDelegate {
    func deleteFile(atPath path: String) throws {
        try FileManager.default.removeItem(atPath: path)
    }

    func executeCommand(_ command: String, arguments: [String]) throws -> String {
        let process = Process()
        process.executableURL = URL(fileURLWithPath: command)
        process.arguments = arguments

        let pipe = Pipe()
        process.standardOutput = pipe

        try process.run()
        process.waitUntilExit()

        let data = pipe.fileHandleForReading.readDataToEndOfFile()
        return String(data: data, encoding: .utf8) ?? ""
    }
}
```

## 性能优化

### 1. 并发处理
```swift
// 使用 async/await
func scanCategories() async -> [CleanCategory] {
    await withTaskGroup(of: CleanCategory.self) { group in
        for category in allCategories {
            group.addTask {
                await self.scanCategory(category)
            }
        }

        var results: [CleanCategory] = []
        for await category in group {
            results.append(category)
        }
        return results
    }
}
```

### 2. 缓存策略
```swift
class CacheManager {
    private var cache: [String: Any] = [:]
    private let queue = DispatchQueue(label: "com.mole.cache")

    func get<T>(_ key: String) -> T? {
        queue.sync {
            cache[key] as? T
        }
    }

    func set<T>(_ key: String, value: T) {
        queue.async {
            self.cache[key] = value
        }
    }
}
```

### 3. 内存管理
```swift
// 使用弱引用避免循环引用
class ViewModel: ObservableObject {
    weak var delegate: ViewModelDelegate?

    // 及时释放大对象
    deinit {
        largeData = nil
    }
}
```

### 4. UI 优化
```swift
// 使用 LazyVStack 延迟加载
LazyVStack {
    ForEach(items) { item in
        ItemView(item: item)
    }
}

// 使用 @State 和 @Binding 减少重绘
struct ItemView: View {
    @Binding var item: Item

    var body: some View {
        // ...
    }
}
```

## 测试策略

### 单元测试
```swift
class CleanServiceTests: XCTestCase {
    func testScanCategories() async throws {
        let service = CleanService()
        let categories = await service.scanCategories { _ in }

        XCTAssertFalse(categories.isEmpty)
        XCTAssertTrue(categories.allSatisfy { $0.size >= 0 })
    }

    func testClean() async throws {
        let service = CleanService()
        let testPath = "/tmp/test"

        // 创建测试文件
        try "test".write(toFile: testPath, atomically: true, encoding: .utf8)

        // 清理
        try await service.deleteFile(testPath)

        // 验证
        XCTAssertFalse(FileManager.default.fileExists(atPath: testPath))
    }
}
```

### UI 测试
```swift
class MoleUITests: XCTestCase {
    func testCleanFlow() throws {
        let app = XCUIApplication()
        app.launch()

        // 点击 Clean
        app.buttons["Clean"].tap()

        // 等待扫描完成
        let scanButton = app.buttons["Start Scan"]
        XCTAssertTrue(scanButton.waitForExistence(timeout: 5))

        scanButton.tap()

        // 等待结果
        let resultView = app.otherElements["CleanResult"]
        XCTAssertTrue(resultView.waitForExistence(timeout: 30))
    }
}
```

## 发布和分发

### 签名和公证
```bash
# 签名
codesign --deep --force --verify --verbose --sign "Developer ID Application: Your Name" MoleUI.app

# 公证
xcrun notarytool submit MoleUI.app.zip --keychain-profile "AC_PASSWORD" --wait

# 装订
xcrun stapler staple MoleUI.app
```

### 分发方式
1. **直接下载**：DMG 文件
2. **Homebrew Cask**：`brew install --cask moleui`
3. **Mac App Store**：（可选）

### 更新机制
```swift
class UpdateManager {
    func checkForUpdates() async -> Update? {
        // 检查 GitHub Releases
        let url = URL(string: "https://api.github.com/repos/tw93/mole/releases/latest")!
        let (data, _) = try await URLSession.shared.data(from: url)
        let release = try JSONDecoder().decode(GitHubRelease.self, from: data)

        if release.version > currentVersion {
            return Update(version: release.version, url: release.downloadURL)
        }

        return nil
    }

    func downloadAndInstall(_ update: Update) async throws {
        // 下载更新
        let (tempURL, _) = try await URLSession.shared.download(from: update.url)

        // 安装更新
        try installUpdate(from: tempURL)
    }
}
```

## 开发路线图

### Phase 1: 核心功能（1-2个月）
- [x] 项目初始化
- [ ] Clean 功能实现
- [ ] Uninstall 功能实现
- [ ] 基础 UI 框架

### Phase 2: 高级功能（2-3个月）
- [ ] Optimize 功能实现
- [ ] Analyze 功能实现
- [ ] Status 功能实现
- [ ] 权限管理

### Phase 3: 完善和优化（1-2个月）
- [ ] Purge 功能实现
- [ ] Installer 功能实现
- [ ] 性能优化
- [ ] UI 优化

### Phase 4: 测试和发布（1个月）
- [ ] 单元测试
- [ ] UI 测试
- [ ] Beta 测试
- [ ] 正式发布

## 参考资源

### 官方文档
- [SwiftUI Documentation](https://developer.apple.com/documentation/swiftui)
- [Combine Framework](https://developer.apple.com/documentation/combine)
- [FileManager](https://developer.apple.com/documentation/foundation/filemanager)

### 开源项目
- [Stats](https://github.com/exelban/stats) - 系统监控
- [AppCleaner](https://freemacsoft.net/appcleaner/) - 应用卸载
- [DaisyDisk](https://daisydiskapp.com/) - 磁盘分析

### 设计资源
- [macOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/macos)
- [SF Symbols](https://developer.apple.com/sf-symbols/)
