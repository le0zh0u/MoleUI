# Clean - 深度清理功能

## 功能概述

深度扫描并清理系统中的缓存、日志、临时文件和其他不必要的数据，帮助用户回收磁盘空间。

## 核心价值

- **空间回收**：通常可回收 20-100GB 空间
- **安全可靠**：内置保护机制，不会删除重要文件
- **智能识别**：自动识别可安全删除的文件
- **预览模式**：支持干运行，先预览再执行

## 清理类别

### 1. Deep System（深度系统清理）
**清理内容**：
- 系统缓存目录
- 系统日志文件
- 临时文件
- 崩溃报告（7天以上）
- 诊断报告

**典型空间**：2-5GB

**风险级别**：低
- 系统会自动重建必要的缓存
- 日志可以安全删除

### 2. User Essentials（用户基础清理）
**清理内容**：
- 用户缓存目录
- 下载文件夹中的旧文件
- 垃圾箱
- 最近项目列表

**典型空间**：5-20GB

**风险级别**：低
- 垃圾箱可恢复
- 下载文件夹需用户确认

### 3. Finder Metadata（Finder元数据）
**清理内容**：
- .DS_Store 文件
- .localized 文件
- Finder缓存

**典型空间**：100-500MB

**风险级别**：极低
- 仅影响Finder显示设置
- 系统会自动重建

### 4. macOS System Caches（macOS系统缓存）
**清理内容**：
- 字体缓存
- 图标缓存
- 启动服务缓存
- Spotlight索引缓存

**典型空间**：1-3GB

**风险级别**：低
- 系统会自动重建
- 可能需要重启生效

### 5. Sandboxed App Caches（沙箱应用缓存）
**清理内容**：
- App Store应用的容器缓存
- 沙箱应用的临时文件

**典型空间**：2-10GB

**风险级别**：低
- 应用会自动重建缓存
- 不影响应用数据

### 6. Browsers（浏览器清理）
**清理内容**：
- Chrome缓存
- Safari缓存
- Firefox缓存
- Edge缓存
- 浏览器临时文件

**典型空间**：5-20GB

**风险级别**：低
- 不删除书签和密码
- 仅清理缓存和临时文件

### 7. Cloud Storage（云存储清理）
**清理内容**：
- Dropbox缓存
- Google Drive缓存
- OneDrive缓存
- iCloud临时文件

**典型空间**：1-5GB

**风险级别**：低
- 不删除同步的文件
- 仅清理本地缓存

### 8. Office Applications（Office应用）
**清理内容**：
- Microsoft Office缓存
- Adobe应用缓存
- Sketch缓存
- Figma缓存

**典型空间**：2-8GB

**风险级别**：低
- 不影响文档
- 仅清理缓存和临时文件

### 9. Developer Tools（开发工具）
**清理内容**：
- Xcode缓存和DerivedData
- npm/yarn/pnpm缓存
- pip/conda缓存
- Docker镜像和容器
- Homebrew缓存
- Go模块缓存
- Rust/cargo缓存
- CocoaPods缓存
- Flutter缓存

**典型空间**：10-50GB

**风险级别**：中
- 可能需要重新下载依赖
- 首次构建会变慢
- 建议使用白名单保护活跃项目

### 10. Virtual Machine Tools（虚拟机工具）
**清理内容**：
- Docker镜像和容器
- Parallels虚拟机快照
- VMware缓存
- VirtualBox日志

**典型空间**：5-30GB

**风险级别**：中
- 可能删除未使用的镜像
- 建议先备份重要虚拟机

### 11. Uninstalled App Data（孤立应用数据）
**清理内容**：
- 已卸载应用的残留数据
- 60天未使用的应用支持文件
- 孤立的Launch Agent/Daemon

**典型空间**：2-10GB

**风险级别**：低
- 仅删除孤立数据
- 60天保护期

### 12. iOS Device Backups（iOS设备备份）
**清理内容**：
- 旧的iOS设备备份
- iTunes备份

**典型空间**：5-50GB

**风险级别**：中
- 删除前需确认
- 建议保留最新备份

### 13. Time Machine Backups（时间机器备份）
**清理内容**：
- 失败的Time Machine备份
- 不完整的备份快照

**典型空间**：1-20GB

**风险级别**：低
- 仅删除失败的备份
- 不影响正常备份

### 14. Large Files Review（大文件检查）
**清理内容**：
- 大于1GB的文件
- 重复文件
- 旧的归档文件

**典型空间**：因用户而异

**风险级别**：高
- 需要用户手动确认
- 可能包含重要文件

## 使用方式

### 基础用法
```bash
mo clean                    # 交互式清理
mo clean --dry-run          # 预览清理计划
mo clean --debug            # 详细日志模式
```

### 白名单管理
```bash
mo clean --whitelist        # 管理白名单
```

### 默认白名单
- Playwright缓存
- Hugging Face模型
- Maven仓库
- Gradle缓存
- Ollama模型
- JetBrains缓存
- Finder缓存
- iCloud文档

## 安全机制

### 路径验证
- 检查路径非空
- 验证符号链接目标
- 拒绝系统保护路径
- 检查控制字符
- 防止路径遍历攻击

### 系统保护路径
永不删除：
- /System
- /bin, /sbin, /usr
- /etc, /var/db
- /Library/Extensions
- /private

### 应用保护
保护关键应用：
- AI工具：Cursor, Claude, ChatGPT, Ollama
- VPN工具：Shadowsocks, V2Ray, Tailscale, Clash
- 系统应用：Control Center, System Settings

### 孤立检测
- 60天未使用才标记为孤立
- 检查应用是否仍然存在
- 验证Launch Agent/Daemon状态

## 操作流程

1. **扫描阶段**
   - 并行扫描各个类别
   - 计算可清理空间
   - 应用白名单过滤

2. **预览阶段**
   - 显示清理计划
   - 显示每个类别的空间
   - 用户确认

3. **执行阶段**
   - 按类别顺序清理
   - 显示实时进度
   - 记录操作日志

4. **完成阶段**
   - 显示清理结果
   - 显示回收空间
   - 显示当前可用空间

## 性能优化

- **并发扫描**：最多15个并行任务
- **智能跳过**：跳过网络卷和外部驱动器
- **超时保护**：防止卡在慢速设备
- **增量清理**：支持部分清理

## 日志记录

### 操作日志
位置：`~/.config/mole/operations.log`

格式：
```
[timestamp] [clean] [delete] [path] [size]
```

### 调试日志
位置：`~/.config/mole/mole_debug_session.log`

包含：
- 风险级别
- 文件详情
- 操作流程
- 错误信息

## 用户体验

### 交互式菜单
- 显示所有清理类别
- 显示每个类别的空间
- 支持多选
- 支持全选/反选

### 进度显示
- 实时进度条
- 当前操作提示
- 已清理空间统计

### 结果展示
```
====================================================================
Space freed: 95.5GB | Free space now: 223.5GB
====================================================================
```

## Mac应用开发建议

### UI设计
1. **主界面**
   - 显示所有清理类别
   - 显示每个类别的空间和风险级别
   - 支持勾选/取消勾选

2. **扫描界面**
   - 显示扫描进度
   - 显示当前扫描的类别
   - 支持取消扫描

3. **预览界面**
   - 显示清理计划
   - 显示详细文件列表
   - 支持展开/折叠

4. **执行界面**
   - 显示清理进度
   - 显示当前操作
   - 显示已回收空间

5. **结果界面**
   - 显示清理结果
   - 显示前后对比
   - 支持查看日志

### 功能增强
1. **定时清理**：支持定期自动清理
2. **智能建议**：根据使用情况推荐清理
3. **空间预警**：磁盘空间不足时提醒
4. **清理历史**：记录每次清理的结果
5. **自定义规则**：支持用户自定义清理规则

### 技术实现
1. **后台扫描**：使用后台线程扫描
2. **增量更新**：实时更新扫描结果
3. **权限管理**：使用SMJobBless请求权限
4. **通知中心**：清理完成后发送通知
5. **菜单栏图标**：显示磁盘使用情况
